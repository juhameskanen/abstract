name: Build and Deploy HTML (GitHub Pages)

on:
  workflow_run:
    workflows: ["Build and Upload PDFs"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-html:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: github-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      - name: Download all PDF Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-pdf.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: all-pdfs
          search_artifacts: true

      - name: Build HTML
        run: |
          set -e

          if [ ! -f papers.json ]; then
            echo "papers.json missing"
            exit 1
          fi

          mkdir -p html
          touch html/.nojekyll
          cp style.css html/style.css

          ROOT_DIR=$(pwd)
          BIB_PATH="$ROOT_DIR/papers/references.bib"
          PROJECT_TITLE=$(jq -r '.title' papers.json)

          echo "<html><head>
          <title>$PROJECT_TITLE</title>
          <meta name='color-scheme' content='light dark'>
          <link rel='stylesheet' href='style.css'>
          </head>
          <body class='bodytext'>
          <h1>$PROJECT_TITLE</h1>" > html/index.html

          # -------------------------------------------------
          # Flatten slugs for previous/next navigation
          # -------------------------------------------------
          mapfile -t ALL_SLUGS < <(jq -r '[.sections[].items[], .sections[].items[]?.children[]?] | .[].slug' papers.json)
          declare -A SLUG_INDEX
          for i in "${!ALL_SLUGS[@]}"; do
            SLUG_INDEX["${ALL_SLUGS[$i]}"]=$i
          done

          # -------------------------------------------------
          # Function: Recursively render sections/items
          # -------------------------------------------------
          render_items() {
            local items_json="$1"
            echo "<ul>"
            local len=$(echo "$items_json" | jq 'length')
            for ((i=0;i<len;i++)); do
              title=$(echo "$items_json" | jq -r ".[$i].title")
              slug=$(echo "$items_json" | jq -r ".[$i].slug")
              children=$(echo "$items_json" | jq ".[$i].children // empty")

              # Create HTML directory
              HTML_DIR="$ROOT_DIR/html/$slug"
              mkdir -p "$HTML_DIR"

              # Copy PDFs if artifacts exist
              if [ -d "all-pdfs/pdf-$slug" ]; then
                cp all-pdfs/pdf-$slug/*.pdf "$HTML_DIR/" || true
              fi

              # Build all tex files in this directory
              TEX_DIR="$ROOT_DIR/papers/$slug"
              if [ -d "$TEX_DIR" ]; then
                while read -r texfile; do
                  base_name=$(basename "$texfile" .tex)
                  out_file="$HTML_DIR/index.html"
                  pushd "$(dirname "$texfile")" > /dev/null
                  pandoc "$(basename "$texfile")" -s -M ishtml=true \
                    --from=latex --to=html5 --citeproc \
                    --mathjax="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" \
                    --bibliography="$BIB_PATH" -c "../style.css" \
                    -o "$out_file"
                  popd > /dev/null
                done < <(find "$TEX_DIR" -name "*.tex" ! -name "common.tex" ! -name "glossary.tex")
              fi

              # Link to PDF (main PDF = any PDF in folder)
              PDF_LINK=""
              if compgen -G "$HTML_DIR/*.pdf" > /dev/null; then
                pdf_file=$(ls "$HTML_DIR"/*.pdf | head -n1)
                pdf_name=$(basename "$pdf_file")
                PDF_LINK=" | <a href='./$pdf_name'>[PDF]</a>"
              fi

              echo "<li><a href='./$slug/'>$title</a>$PDF_LINK"

              # Recurse if children exist
              if [ "$children" != "" ]; then
                child_json=$(echo "$children" | jq -c '.')
                render_items "$child_json"
              fi

              echo "</li>"
            done
            echo "</ul>"
          }

          # -------------------------------------------------
          # Render all sections
          # -------------------------------------------------
          SECTION_COUNT=$(jq '.sections | length' papers.json)
          for ((s=0; s<SECTION_COUNT; s++)); do
            section_title=$(jq -r ".sections[$s].title" papers.json)
            items_json=$(jq -c ".sections[$s].items" papers.json)

            echo "<h2>$section_title</h2>" >> html/index.html
            render_items "$items_json" >> html/index.html
          done

          echo "</body></html>" >> html/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: html

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
