name: Build and Deploy HTML (GitHub Pages)

on:
  workflow_run:
    workflows: ["Build and Upload PDFs"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-html:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: github-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      - name: Download all PDF Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-pdf.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: all-pdfs
          search_artifacts: true

      - name: Convert LaTeX to HTML and Integrate PDFs
        run: |
          if [ ! -f papers.json ]; then echo "papers.json missing"; exit 1; fi
          mkdir -p html
          touch html/.nojekyll
          cp style.css html/style.css

          ROOT_DIR=$(pwd)
          BIB_PATH="$ROOT_DIR/papers/references.bib"

          # Start index
          TITLE=$(jq -r '.title' papers.json)
          echo "<html><head><title>$TITLE</title><meta name='color-scheme' content='light dark'><link rel='stylesheet' href='style.css'></head><body class='bodytext'><h1>$TITLE</h1>" > html/index.html

          # Recursive function to process JSON items
          process_items() {
            ITEMS_JSON="$1"
            PARENT_SLUG="$2"

            echo "<ul>" >> html/index.html
            echo "$ITEMS_JSON" | jq -c '.[]' | while read -r item; do
              TITLE=$(echo "$item" | jq -r '.title')
              SLUG=$(echo "$item" | jq -r '.slug')

              # Full slug path for nested items
              if [ -z "$PARENT_SLUG" ]; then
                FULL_SLUG="$SLUG"
              else
                FULL_SLUG="$PARENT_SLUG/$SLUG"
              fi

              # HTML folder
              HTML_DIR="html/$FULL_SLUG"
              mkdir -p "$HTML_DIR"

              # Find flattened PDF
              SAFE_SLUG=$(echo "$FULL_SLUG" | sed 's|/|-|g')
              PDF_FILE=$(find all-pdfs -type f -name "*$SAFE_SLUG*.pdf" | head -n1)
              PDF_LINK=""
              if [ -n "$PDF_FILE" ]; then
                cp "$PDF_FILE" "$HTML_DIR/"
                PDF_BASENAME=$(basename "$PDF_FILE")
                PDF_LINK=" | <a href='./$PDF_BASENAME'>[PDF]</a>"
              fi

              # Convert all .tex files in the papers folder
              TEX_DIR="papers/$FULL_SLUG"
              if [ -d "$TEX_DIR" ]; then
                find "$TEX_DIR" -name "*.tex" ! -name "common.tex" ! -name "glossary.tex" | while read -r tex; do
                  BASE=$(basename "$tex" .tex)
                  CSS_REL=$(realpath --relative-to="$HTML_DIR" style.css)
                  [ -d "$TEX_DIR/figures" ] && cp -r "$TEX_DIR/figures" "$HTML_DIR/"
                  (cd "$(dirname "$tex")" && pandoc "$BASE.tex" -s -M ishtml=true --from=latex --to=html5 --citeproc \
                    --mathjax="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" \
                    --bibliography="$BIB_PATH" -c "$CSS_REL" -o "$HTML_DIR/index.html")
                done
              fi

              echo "<li><a href='./$FULL_SLUG/'>$TITLE</a>$PDF_LINK" >> html/index.html

              # Process children recursively
              CHILDREN=$(echo "$item" | jq -c '.children // []')
              if [ "$(echo "$CHILDREN" | jq 'length')" -gt 0 ]; then
                process_items "$CHILDREN" "$FULL_SLUG"
              fi

              echo "</li>" >> html/index.html
            done
            echo "</ul>" >> html/index.html
          }

          # Loop over top-level sections
          jq -c '.sections[]' papers.json | while read -r section; do
            SECTION_TITLE=$(echo "$section" | jq -r '.title')
            echo "<h2>$SECTION_TITLE</h2>" >> html/index.html
            ITEMS=$(echo "$section" | jq -c '.items')
            process_items "$ITEMS" ""
          done

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: html

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
