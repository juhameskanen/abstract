name: Build and Deploy HTML (GitHub Pages)

on:
  workflow_run:
    workflows: ["Build and Upload PDFs"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-html:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: github-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      - name: Download all PDF Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-pdf.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: all-pdfs
          search_artifacts: true

      - name: Convert LaTeX to HTML and Integrate PDFs
        run: |
          if [ ! -f papers.json ]; then
            echo "papers.json missing"
            exit 1
          fi

          ROOT_DIR=$(pwd)
          HTML_ROOT="$ROOT_DIR/html"
          BIB_PATH="$ROOT_DIR/papers/references.bib"

          mkdir -p "$HTML_ROOT"
          touch "$HTML_ROOT/.nojekyll"
          cp "$ROOT_DIR/style.css" "$HTML_ROOT/"

          # Start index
          TITLE=$(jq -r '.title' papers.json)
          echo "<html><head><title>$TITLE</title><meta name='color-scheme' content='light dark'><link rel='stylesheet' href='style.css'></head><body class='bodytext'><h1>$TITLE</h1>" > "$HTML_ROOT/index.html"

          # Recursive function to process items
          process_items() {
            ITEMS_JSON="$1"
            PARENT_SLUG="$2"

            echo "<ul>" >> "$HTML_ROOT/index.html"
            echo "$ITEMS_JSON" | jq -c '.[]' | while read -r item; do
              TITLE=$(echo "$item" | jq -r '.title')
              SLUG=$(echo "$item" | jq -r '.slug')

              # Full slug path
              if [ -z "$PARENT_SLUG" ]; then
                FULL_SLUG="$SLUG"
              else
                FULL_SLUG="$PARENT_SLUG/$SLUG"
              fi

              HTML_DIR="$HTML_ROOT/$FULL_SLUG"
              mkdir -p "$HTML_DIR"

              TEX_DIR="$ROOT_DIR/papers/$FULL_SLUG"
              SAFE_SLUG=$(echo "$FULL_SLUG" | sed 's|/|-|g')

              # Copy flattened PDF if it exists
              PDF_FILE=$(find "$ROOT_DIR/all-pdfs" -type f -name "*$SAFE_SLUG*.pdf" | head -n1)
              PDF_LINK=""
              if [ -n "$PDF_FILE" ]; then
                cp "$PDF_FILE" "$HTML_DIR/"
                PDF_BASENAME=$(basename "$PDF_FILE")
                PDF_LINK=" | <a href='./$PDF_BASENAME'>[PDF]</a>"
              fi

              # Convert all .tex files in the papers folder
              if [ -d "$TEX_DIR" ]; then
                pushd "$TEX_DIR" > /dev/null
                find . -name "*.tex" ! -name "common.tex" ! -name "glossary.tex" | while read -r tex; do
                  BASE=$(basename "$tex" .tex)
                  [ -d "./figures" ] && cp -r "./figures" "$HTML_DIR/"
                  CSS_REL=$(realpath --relative-to="$HTML_DIR" "$HTML_ROOT/style.css")
                  mkdir -p "$HTML_DIR"
                  CURRENT_TEX_DIR=$(dirname "$tex")
                  pandoc "$tex" -s -M ishtml=true --from=latex --to=html5 --citeproc \
                    --resource-path=".:$CURRENT_TEX_DIR:$ROOT_DIR/papers" \
                    --mathjax="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" \
                    --bibliography="$BIB_PATH" -c "$CSS_REL" -o "$HTML_DIR/index.html"
                done
                popd > /dev/null
              fi

              echo "<li><a href='./$FULL_SLUG/'>$TITLE</a>$PDF_LINK" >> "$HTML_ROOT/index.html"

              # Recursively process children
              CHILDREN=$(echo "$item" | jq -c '.children // []')
              if [ "$(echo "$CHILDREN" | jq 'length')" -gt 0 ]; then
                process_items "$CHILDREN" "$FULL_SLUG"
              fi

              echo "</li>" >> "$HTML_ROOT/index.html"
            done
            echo "</ul>" >> "$HTML_ROOT/index.html"
          }

          # Loop over top-level sections
          jq -c '.sections[]' papers.json | while read -r section; do
            SECTION_TITLE=$(echo "$section" | jq -r '.title')
            echo "<h2>$SECTION_TITLE</h2>" >> "$HTML_ROOT/index.html"
            ITEMS=$(echo "$section" | jq -c '.items')
            process_items "$ITEMS" ""
          done

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: html

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
