name: Build and Deploy HTML (GitHub Pages)

on:
  workflow_run:
    workflows: ["Build and Upload PDFs"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-html:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: github-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      - name: Download all PDF Artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-pdf.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: all-pdfs
          search_artifacts: true

      - name: Convert LaTeX to HTML and Integrate PDFs
        run: |
          if [ ! -f papers.json ]; then
            echo "papers.json missing"
            exit 1
          fi

          ROOT_DIR=$(pwd)
          HTML_ROOT="$ROOT_DIR/html"
          BIB_PATH="$ROOT_DIR/papers/references.bib"

          mkdir -p "$HTML_ROOT"
          touch "$HTML_ROOT/.nojekyll"
          cp "$ROOT_DIR/style.css" "$HTML_ROOT/"

          # 1. Flatten all papers into a global list for Prev/Next navigation
          # This follows the same structure as your build matrix
          FLAT_PAPERS_JSON=$(jq -c '
            [
              .sections[].items[] as $item |
              $item.slug as $slug |
              if ($item.children? | length > 0) then
                $item.children[] | {slug: "\($slug)/\(.slug)", title: .title}
              else
                {slug: $slug, title: .title}
              end
            ]' papers.json)

          # Start index
          TITLE=$(jq -r '.title' papers.json)
          echo "<html><head><title>$TITLE</title><meta name='color-scheme' content='light dark'><link rel='stylesheet' href='style.css'></head><body class='bodytext'><h1>$TITLE</h1>" > "$HTML_ROOT/index.html"

          # Recursive function to process items
          process_items() {
            ITEMS_JSON="$1"
            PARENT_SLUG="$2"

            echo "<ul>" >> "$HTML_ROOT/index.html"
            echo "$ITEMS_JSON" | jq -c '.[]' | while read -r item; do
              ITEM_TITLE=$(echo "$item" | jq -r '.title')
              SLUG=$(echo "$item" | jq -r '.slug')

              if [ -z "$PARENT_SLUG" ]; then
                FULL_SLUG="$SLUG"
              else
                FULL_SLUG="$PARENT_SLUG/$SLUG"
              fi

              HTML_DIR="$HTML_ROOT/$FULL_SLUG"
              mkdir -p "$HTML_DIR"
              TEX_DIR="$ROOT_DIR/papers/$FULL_SLUG"
              SAFE_SLUG=$(echo "$FULL_SLUG" | sed 's|/|-|g')

              # PDF Linking logic
              PDF_FILE=$(find "$ROOT_DIR/all-pdfs" -type f -name "*$SAFE_SLUG*.pdf" | head -n1)
              PDF_LINK=""
              if [ -n "$PDF_FILE" ]; then
                cp "$PDF_FILE" "$HTML_DIR/"
                PDF_BASENAME=$(basename "$PDF_FILE")
                PDF_LINK=" | <a href='./$PDF_BASENAME'>[PDF]</a>"
              fi

              # --- NAV FOOTER GENERATION ---
              CURRENT_INDEX=$(echo "$FLAT_PAPERS_JSON" | jq -r "map(.slug == \"$FULL_SLUG\") | index(true)")
              PREV_HTML="[Start]"
              NEXT_HTML="[End]"
              
              # Calculate path back to root (for TOC and relative Prev/Next)
              DEPTH=$(echo "$FULL_SLUG" | tr -cd '/' | wc -c)
              TO_ROOT=".."
              for ((i=0; i<DEPTH; i++)); do TO_ROOT="../$TO_ROOT"; done

              if [ "$CURRENT_INDEX" != "null" ] && [ "$CURRENT_INDEX" -gt 0 ]; then
                P_SLUG=$(echo "$FLAT_PAPERS_JSON" | jq -r ".[$CURRENT_INDEX - 1].slug")
                P_TITLE=$(echo "$FLAT_PAPERS_JSON" | jq -r ".[$CURRENT_INDEX - 1].title")
                PREV_HTML="<a href='$TO_ROOT/$P_SLUG/'>&larr; $P_TITLE</a>"
              fi

              TOTAL=$(echo "$FLAT_PAPERS_JSON" | jq 'length')
              if [ "$CURRENT_INDEX" != "null" ] && [ "$CURRENT_INDEX" -lt $((TOTAL - 1)) ]; then
                N_SLUG=$(echo "$FLAT_PAPERS_JSON" | jq -r ".[$CURRENT_INDEX + 1].slug")
                N_TITLE=$(echo "$FLAT_PAPERS_JSON" | jq -r ".[$CURRENT_INDEX + 1].title")
                NEXT_HTML="<a href='$TO_ROOT/$N_SLUG/'>$N_TITLE &rarr;</a>"
              fi

              FOOTER_FILE="/tmp/footer-$SAFE_SLUG.html"
              echo "<hr><div class='nav-footer'><a href='$TO_ROOT/index.html'>&uarr; Up (TOC)</a> | $PREV_HTML | $NEXT_HTML <br><br><i>© 2026 The Abstract Universe Theory Project.</i></div>" > "$FOOTER_FILE"
              # --- END NAV FOOTER ---

              if [ -d "$TEX_DIR" ]; then
                find "$TEX_DIR" -name "*.tex" ! -name "common.tex" ! -name "glossary.tex" | while read -r tex; do
                  ABS_BIB=$(realpath "$BIB_PATH")
                  CSS_REL=$(realpath --relative-to="$HTML_DIR" "$HTML_ROOT/style.css")
                  FILE_DIR=$(dirname "$(realpath "$tex")")
                  FILE_NAME=$(basename "$tex")

                  [ -d "$FILE_DIR/figures" ] && cp -r "$FILE_DIR/figures" "$HTML_DIR/"
                  [ -d "$FILE_DIR/simulations" ] && cp -r "$FILE_DIR/simulations" "$HTML_DIR/"
                  find "$FILE_DIR" -maxdepth 1 -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.pdf" -o -iname "*.svg" \) -exec cp {} "$HTML_DIR/" \;

                  pushd "$FILE_DIR" > /dev/null
                    pandoc "$FILE_NAME" -s -M ishtml=true --from=latex --to=html5 --citeproc \
                      --mathjax="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" \
                      --bibliography="$ABS_BIB" \
                      -c "$CSS_REL" \
                      -A "$FOOTER_FILE" \
                      -o "$HTML_DIR/index.html"
                  popd > /dev/null
                done
              fi
              
              # Inside the while loop for items, updating the main index.html
              if [ -n "$PDF_FILE" ]; then
                # Link from the ROOT index needs to point into the subfolder
                INDEX_PDF_LINK=" | <a href='./$FULL_SLUG/$PDF_BASENAME'>[PDF]</a>"
              else
                INDEX_PDF_LINK=""
              fi
              
              echo "<li><a href='./$FULL_SLUG/'>$ITEM_TITLE</a>$INDEX_PDF_LINK" >> "$HTML_ROOT/index.html"
              CHILDREN=$(echo "$item" | jq -c '.children // []')
              if [ "$(echo "$CHILDREN" | jq 'length')" -gt 0 ]; then
                process_items "$CHILDREN" "$FULL_SLUG"
              fi
              echo "</li>" >> "$HTML_ROOT/index.html"
            done
            echo "</ul>" >> "$HTML_ROOT/index.html"
          }

          jq -c '.sections[]' papers.json | while read -r section; do
            SECTION_TITLE=$(echo "$section" | jq -r '.title')
            echo "<h2>$SECTION_TITLE</h2>" >> "$HTML_ROOT/index.html"
            ITEMS=$(echo "$section" | jq -c '.items')
            process_items "$ITEMS" ""
          done

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: html

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
