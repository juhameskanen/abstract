name: Build and Deploy HTML (GitHub Pages)

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Upload PDFs"]
    types: [completed]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          # Flatten all slugs recursively with parent path
          MATRIX=$(jq -c '[.sections[].items[] as $i | $i.slug as $s | (if ($i.children? | length > 0) then $i.children[] | "\($s)/\(.slug)" else $s end)] | .[]' papers.json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  build-html:
    needs: setup
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc jq

      - name: Download PDF artifacts
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: build-pdf.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: all-pdfs
          search_artifacts: true

      - name: Convert LaTeX to HTML and integrate PDFs
        run: |
          ROOT=$(pwd)
          HTML_DIR="$ROOT/html"
          mkdir -p "$HTML_DIR"
          touch "$HTML_DIR/.nojekyll"
          cp style.css "$HTML_DIR/"

          echo '<html><head><title>The Abstract Universe Project (AUP)</title>
          <meta name="color-scheme" content="light dark">
          <link rel="stylesheet" href="style.css"></head><body class="bodytext">
          <h1>The Abstract Universe Project (AUP)</h1>' > "$HTML_DIR/index.html"

          # Recursive function to process items
          process_items() {
            ITEMS_JSON="$1"
            PARENT_PATH="$2"
            echo "<ul>" >> "$HTML_DIR/index.html"
            echo "$ITEMS_JSON" | jq -c '.[]' | while read -r item; do
              TITLE=$(echo "$item" | jq -r '.title')
              SLUG=$(echo "$item" | jq -r '.slug')
              if [ -z "$PARENT_PATH" ]; then
                FULL_SLUG="$SLUG"
              else
                FULL_SLUG="$PARENT_PATH/$SLUG"
              fi

              # Paths
              TEX_DIR="$ROOT/papers/$FULL_SLUG"
              TARGET_HTML="$HTML_DIR/$FULL_SLUG"
              mkdir -p "$TARGET_HTML"

              # Copy PDF artifact (preserve hierarchy)
              PDF_SRC=$(find "$ROOT/all-pdfs" -type f -name "*$(basename $SLUG)*.pdf" | head -n1)
              if [ -n "$PDF_SRC" ]; then
                cp "$PDF_SRC" "$TARGET_HTML/"
                PDF_FILE=$(basename "$PDF_SRC")
              else
                PDF_FILE=""
              fi

              # Convert .tex files to HTML in the same folder
              if [ -d "$TEX_DIR" ]; then
                for tex in $(find "$TEX_DIR" -name "*.tex" ! -name "common.tex" ! -name "glossary.tex"); do
                  BASE=$(basename "$tex" .tex)
                  [ -d "$(dirname $TARGET_HTML)/figures" ] && cp -r "$TEX_DIR/figures" "$TARGET_HTML/"
                  CSS_PATH=$(python3 -c "import os; depth='$FULL_SLUG'.count('/'); print('../'*depth + 'style.css')")
                  pandoc "$tex" --from=latex --to=html5 --citeproc \
                    --mathjax="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" \
                    --bibliography="$ROOT/papers/references.bib" \
                    -c "$CSS_PATH" -o "$TARGET_HTML/index.html"
                  # PDF link
                  if [ -n "$PDF_FILE" ]; then
                    sed -i "s|</body>|<p><a href='./$PDF_FILE'>[PDF]</a></p></body>|" "$TARGET_HTML/index.html"
                  fi
                done
              fi

              # Add TOC entry
              if [ -n "$PDF_FILE" ]; then
                echo "<li><a href='./$FULL_SLUG/'>$TITLE</a> | <a href='./$FULL_SLUG/$PDF_FILE'>[PDF]</a>" >> "$HTML_DIR/index.html"
              else
                echo "<li><a href='./$FULL_SLUG/'>$TITLE</a>" >> "$HTML_DIR/index.html"
              fi

              # Recursively process children
              CHILDREN=$(echo "$item" | jq -c '.children // []')
              if [ "$(echo "$CHILDREN" | jq 'length')" -gt 0 ]; then
                process_items "$CHILDREN" "$FULL_SLUG"
              fi
              echo "</li>" >> "$HTML_DIR/index.html"
            done
            echo "</ul>" >> "$HTML_DIR/index.html"
          }

          # Process top-level sections
          for section in $(jq -c '.sections[]' papers.json); do
            SECTION_TITLE=$(echo "$section" | jq -r '.title')
            echo "<h2>$SECTION_TITLE</h2>" >> "$HTML_DIR/index.html"
            ITEMS=$(echo "$section" | jq -c '.items')
            process_items "$ITEMS" ""
          done

          echo "</body></html>" >> "$HTML_DIR/index.html"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: html

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
